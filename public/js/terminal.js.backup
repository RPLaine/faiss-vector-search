/* Terminal Interface JavaScript */

const API_BASE = 'http://localhost:8000';
let ws = null;
let isProcessing = false;

// Initialize on page load
window.onload = () => {
    connectWebSocket();
    loadStatus();
    document.getElementById('query-input').focus();
};

// WebSocket Connection
function connectWebSocket() {
    ws = new WebSocket('ws://localhost:8000/ws');

    ws.onopen = () => {
        updateStatus('Connected', true);
        appendOutput('System: Connected to RAG server', 'system');
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('WebSocket message received:', data.type, data);
        handleWebSocketMessage(data);
    };

    ws.onclose = () => {
        updateStatus('Disconnected', false);
        setTimeout(connectWebSocket, 5000);
    };

    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateStatus('Error', false);
    };
}

function handleWebSocketMessage(data) {
    console.log('WebSocket message:', data);
    
    if (data.type === 'connection_established') {
        const status = data.status;
        updateStatus(`${status.total_documents} docs | ${status.llm_model}`, true);
    }
    // Handle program actions with structured data
    else if (data.action === 'retrieval_start') {
        displayRetrievalStart(data.data);
    }
    else if (data.action === 'retrieval_complete') {
        displayRetrievalComplete(data.data);
    }
    else if (data.action === 'llm_request') {
        displayLLMRequest(data.data);
    }
    else if (data.action === 'llm_response') {
        displayLLMResponse(data.data);
    }
    else if (data.action === 'evaluation_start') {
        displayEvaluationStart(data.data);
    }
    else if (data.action === 'evaluation_complete') {
        displayEvaluationComplete(data.data);
    }
    else if (data.action === 'temperature_test') {
        displayTemperatureTest(data.data);
    }
    else if (data.action === 'improvement_iteration') {
        displayImprovementIteration(data.data);
    }
    // Legacy message types (keep for backward compatibility)
    else if (data.type === 'query_start') {
        appendOutput(`\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'info');
        appendOutput(`‚ö° Starting query processing...`, 'system');
    } 
    else if (data.type === 'query_complete') {
        appendOutput(`‚úÖ Query completed in ${data.processing_time?.toFixed(2)}s`, 'success');
        appendOutput(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`, 'info');
    }
}

// Status Functions
async function loadStatus() {
    try {
        const response = await fetch(`${API_BASE}/api/status`);
        const status = await response.json();
        updateStatus(`${status.total_documents} docs | ${status.llm_model}`, true);
    } catch (error) {
        updateStatus('Cannot connect to server', false);
        appendOutput('Error: Cannot connect to RAG API server', 'error');
        appendOutput('Please ensure api_server.py is running on port 8000', 'info');
    }
}

function updateStatus(text, connected) {
    document.getElementById('terminalInfo').textContent = text;
    const dot = document.getElementById('statusDot');
    if (connected) {
        dot.classList.remove('disconnected');
    } else {
        dot.classList.add('disconnected');
    }
}

// Query Execution
async function executeQuery() {
    const input = document.getElementById('query-input');
    const query = input.value.trim();

    if (!query) return;

    // Handle special commands
    if (query.toLowerCase() === 'clear') {
        clearTerminal();
        input.value = '';
        return;
    }

    if (query.toLowerCase() === 'help') {
        showHelp();
        input.value = '';
        return;
    }

    if (isProcessing) {
        appendOutput('System: Please wait for current query to complete', 'error');
        return;
    }

    // Display query with separator
    appendOutput(`\n${'‚ïê'.repeat(60)}`, 'system');
    appendOutput(`Query: ${query}`, 'query');
    appendOutput(`${'‚ïê'.repeat(60)}`, 'system');
    input.value = '';

    // Get selected mode
    const selectedMode = document.querySelector('input[name="queryMode"]:checked').value;
    const optimize = selectedMode === 'optimize';
    const useFaiss = selectedMode === 'faiss';
    
    // Set loading state
    setLoading(true);

    try {
        // Send query request
        const response = await fetch(`${API_BASE}/api/query`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                use_context: useFaiss,
                optimize: optimize,
                improve: false,
                template_name: 'base'
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        // Small delay to ensure all WebSocket messages have been processed
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Display the final formatted response
        displayResponse(result);

    } catch (error) {
        appendOutput(`\n‚ùå Error: ${error.message}`, 'error');
        if (error.message.includes('fetch')) {
            appendOutput('Tip: Ensure api_server.py is running on port 8000', 'info');
        }
    } finally {
        setLoading(false);
    }
}

// Display Response
function displayResponse(result) {
    // Add separator before response
    appendOutput(`\n${'‚îÄ'.repeat(60)}`, 'system');
    appendOutput(`üìä RESULTS`, 'system');
    appendOutput(`${'‚îÄ'.repeat(60)}\n`, 'system');
    
    // Main response
    appendOutput(`Response:\n${result.response}`, 'response');

    // Build metadata array with all available information
    const metadata = [];
    
    // Basic metrics
    if (result.processing_time) {
        metadata.push(`‚è±Ô∏è  Processing Time: ${result.processing_time.toFixed(2)}s`);
    }
    if (result.num_docs_found !== undefined) {
        metadata.push(`üìÑ Documents Found: ${result.num_docs_found}`);
    }
    if (result.response) {
        metadata.push(`üìù Response Length: ${result.response.length} characters`);
    }
    
    // Feature flags
    if (result.optimization_applied) {
        metadata.push(`üéØ Optimization Score: ${result.optimization_score?.toFixed(2)}`);
    }
    if (result.improvement_applied) {
        metadata.push(`üîÑ Improvement Iterations: ${result.improvement_iterations}`);
    }
    
    appendMetadata(metadata);
    
    // Display configuration if available
    if (result.config_params) {
        displayConfiguration(result.config_params);
    }
    
    // Display source documents if available
    if (result.context_docs && result.context_docs.length > 0) {
        displaySourceDocuments(result.context_docs);
    }
    
    // Display threshold progression if available
    if (result.threshold_stats) {
        displayThresholdProgression(result.threshold_stats);
    }

    // Scroll to bottom
    scrollToBottom();
}

function displayConfiguration(config) {
    const contentArea = document.getElementById('contentArea');
    
    // Create configuration section
    const configSection = document.createElement('div');
    configSection.className = 'config-section';
    
    const title = document.createElement('div');
    title.className = 'section-title';
    title.textContent = '‚öôÔ∏è  Configuration';
    configSection.appendChild(title);
    
    const configGrid = document.createElement('div');
    configGrid.className = 'config-grid';
    
    const configItems = [
        { label: 'LLM Model', value: config.llm_model },
        { label: 'Max Tokens', value: config.max_tokens },
        { label: 'Temperature', value: config.temperature },
        { label: 'Embedding Model', value: config.embedding_model },
        { label: 'Dimensions', value: config.dimension },
        { label: 'Top K', value: config.top_k },
        { label: 'Similarity Threshold', value: config.similarity_threshold },
        { label: 'Max Context Length', value: config.max_context_length },
        { label: 'Index Type', value: config.index_type }
    ];
    
    // Add hit target if available
    if (config.hit_target && config.hit_target !== 'N/A') {
        configItems.push({ label: 'Hit Target', value: config.hit_target });
        configItems.push({ label: 'Step Size', value: config.step });
    }
    
    configItems.forEach(item => {
        if (item.value && item.value !== 'N/A') {
            const configItem = document.createElement('div');
            configItem.className = 'config-item';
            configItem.innerHTML = `<span class="config-label">${item.label}:</span> <span class="config-value">${item.value}</span>`;
            configGrid.appendChild(configItem);
        }
    });
    
    configSection.appendChild(configGrid);
    contentArea.appendChild(configSection);
}

function displaySourceDocuments(docs) {
    const contentArea = document.getElementById('contentArea');
    
    const docsSection = document.createElement('div');
    docsSection.className = 'docs-section';
    
    const title = document.createElement('div');
    title.className = 'section-title';
    title.textContent = 'üìö Source Documents';
    docsSection.appendChild(title);
    
    docs.forEach((doc, index) => {
        const docBox = document.createElement('div');
        docBox.className = 'source-document';
        
        let content, filename;
        if (typeof doc === 'object') {
            content = doc.content || JSON.stringify(doc);
            filename = doc.filename || `Document ${index + 1}`;
        } else {
            content = doc;
            filename = `Document ${index + 1}`;
        }
        
        const docTitle = document.createElement('div');
        docTitle.className = 'doc-title';
        docTitle.textContent = filename;
        
        const docContent = document.createElement('div');
        docContent.className = 'doc-content';
        docContent.textContent = content;
        
        docBox.appendChild(docTitle);
        docBox.appendChild(docContent);
        docsSection.appendChild(docBox);
    });
    
    contentArea.appendChild(docsSection);
}

function displayThresholdProgression(stats) {
    const contentArea = document.getElementById('contentArea');
    
    const thresholdSection = document.createElement('div');
    thresholdSection.className = 'threshold-section';
    
    const title = document.createElement('div');
    title.className = 'section-title';
    title.textContent = 'üéØ Dynamic Threshold Progression';
    thresholdSection.appendChild(title);
    
    const table = document.createElement('table');
    table.className = 'threshold-table';
    
    // Header
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Iteration</th>
            <th>Threshold</th>
            <th>Hits</th>
            <th>Status</th>
        </tr>
    `;
    table.appendChild(thead);
    
    // Body
    const tbody = document.createElement('tbody');
    stats.progression.forEach(item => {
        const row = document.createElement('tr');
        const statusIcon = item.status === 'success' ? '‚úÖ' : 
                          item.status === 'failed' ? '‚ùå' : 'üîÑ';
        row.innerHTML = `
            <td>${item.iteration}</td>
            <td>${item.threshold.toFixed(3)}</td>
            <td>${item.hits}</td>
            <td>${statusIcon} ${item.status}</td>
        `;
        tbody.appendChild(row);
    });
    table.appendChild(tbody);
    
    thresholdSection.appendChild(table);
    contentArea.appendChild(thresholdSection);
}

// Output Functions
function appendOutput(text, className = '') {
    const contentArea = document.getElementById('contentArea');
    const line = document.createElement('div');
    line.className = `output-line ${className}`;
    line.textContent = text;
    contentArea.appendChild(line);
    scrollToBottom();
}

function appendMetadata(items) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = 'metadata-box';
    
    items.forEach(item => {
        const span = document.createElement('span');
        span.className = 'metadata-item';
        span.innerHTML = item;
        box.appendChild(span);
    });
    
    contentArea.appendChild(box);
}

// Command Functions
function showHelp() {
    appendOutput('Available commands:', 'system');
    appendOutput('  clear    - Clear the terminal', 'info');
    appendOutput('  help     - Show this help message', 'info');
    appendOutput('  [query]  - Ask a question to the RAG system', 'info');
    appendOutput('', '');
    appendOutput('Modes:', 'system');
    appendOutput('  Optimize - Use temperature optimization', 'info');
    appendOutput('  FAISS    - Standard FAISS retrieval (default)', 'info');
    appendOutput('  None     - Direct LLM query without context', 'info');
}

function clearTerminal() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="welcome-message">
            <h3>ü§ñ RAG System Terminal</h3>
            <ul>
                <li>Terminal cleared</li>
                <li>Ready for new queries</li>
                <li>Type 'help' for available commands</li>
            </ul>
        </div>
    `;
}

// UI Functions
function setLoading(loading) {
    isProcessing = loading;
    document.getElementById('executeBtn').disabled = loading;
    document.getElementById('query-input').disabled = loading;
    
    const indicator = document.getElementById('loadingIndicator');
    if (loading) {
        indicator.classList.add('active');
    } else {
        indicator.classList.remove('active');
    }
}

function scrollToBottom() {
    const contentArea = document.getElementById('contentArea');
    contentArea.scrollTop = contentArea.scrollHeight;
}

// Event Listeners
document.getElementById('query-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        executeQuery();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        clearTerminal();
    }
});

// Structured Component Display Functions - Action-Based

function displayRetrievalStart(data) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = 'action-box retrieval-box';
    box.innerHTML = `
        <div class="action-header">üîç Dynamic Retrieval</div>
        <div class="action-details">
            <div class="detail-item"><span class="label">Query:</span> ${escapeHtml(data.query)}</div>
            <div class="detail-item"><span class="label">Top K:</span> ${data.top_k}</div>
            <div class="detail-item"><span class="label">Threshold:</span> ${data.threshold}</div>
        </div>
    `;
    contentArea.appendChild(box);
    scrollToBottom();
}

function displayRetrievalComplete(data) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = 'action-box retrieval-result-box';
    box.innerHTML = `
        <div class="action-header">‚úÖ Retrieval Complete</div>
        <div class="action-details">
            <div class="detail-item"><span class="label">Documents Found:</span> ${data.num_docs}</div>
            <div class="detail-item"><span class="label">Time:</span> ${data.time.toFixed(2)}s</div>
        </div>
    `;
    
    if (data.documents && data.documents.length > 0) {
        const docsSection = document.createElement('div');
        docsSection.className = 'docs-section';
        const docsHeader = document.createElement('div');
        docsHeader.className = 'docs-header collapsible-header';
        docsHeader.innerHTML = 'üìö Retrieved Documents <span class="toggle-btn">[collapse]</span>';
        docsHeader.onclick = () => {
            docsSection.classList.toggle('collapsed');
            docsHeader.querySelector('.toggle-btn').textContent = 
                docsSection.classList.contains('collapsed') ? '[expand]' : '[collapse]';
        };
        docsSection.appendChild(docsHeader);
        
        const docsContainer = document.createElement('div');
        docsContainer.className = 'docs-container';
        
        data.documents.forEach((doc, idx) => {
            const content = typeof doc === 'string' ? doc : (doc.content || JSON.stringify(doc));
            const docItem = document.createElement('div');
            docItem.className = 'doc-item';
            
            const docHeader = document.createElement('div');
            docHeader.className = 'doc-item-header';
            docHeader.textContent = `Document ${idx + 1}`;
            if (doc.filename) {
                docHeader.textContent = `${idx + 1}. ${doc.filename}`;
            }
            if (doc.score !== undefined) {
                const scoreSpan = document.createElement('span');
                scoreSpan.className = 'doc-score';
                scoreSpan.textContent = `Score: ${doc.score.toFixed(3)}`;
                docHeader.appendChild(scoreSpan);
            }
            
            const docContent = document.createElement('div');
            docContent.className = 'doc-item-content';
            docContent.textContent = content; // Full content, no truncation
            
            docItem.appendChild(docHeader);
            docItem.appendChild(docContent);
            docsContainer.appendChild(docItem);
        });
        
        docsSection.appendChild(docsContainer);
        box.appendChild(docsSection);
    }
    
    contentArea.appendChild(box);
    scrollToBottom();
}

function displayLLMRequest(data) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = 'action-box llm-request-box';
    
    box.innerHTML = `
        <div class="action-header">üöÄ LLM API Request</div>
        <div class="action-details">
            <div class="detail-item"><span class="label">Endpoint:</span> ${escapeHtml(data.endpoint)}</div>
            <div class="detail-item"><span class="label">Model:</span> ${data.model}</div>
            <div class="detail-item"><span class="label">Temperature:</span> ${data.temperature}</div>
            <div class="detail-item"><span class="label">Max Tokens:</span> ${data.max_tokens}</div>
        </div>
    `;
    
    // Add collapsible prompt section (full content)
    const promptSection = document.createElement('div');
    promptSection.className = 'prompt-section';
    const promptHeader = document.createElement('div');
    promptHeader.className = 'prompt-header collapsible-header';
    promptHeader.innerHTML = 'üìù Prompt <span class="toggle-btn">[collapse]</span>';
    promptHeader.onclick = () => {
        promptSection.classList.toggle('collapsed');
        promptHeader.querySelector('.toggle-btn').textContent = 
            promptSection.classList.contains('collapsed') ? '[expand]' : '[collapse]';
    };
    promptSection.appendChild(promptHeader);
    
    const promptContent = document.createElement('pre');
    promptContent.className = 'prompt-content';
    promptContent.textContent = data.prompt; // Full prompt, no truncation
    promptSection.appendChild(promptContent);
    box.appendChild(promptSection);
    
    // Add collapsible payload
    const payloadSection = document.createElement('div');
    payloadSection.className = 'payload-section collapsed';
    const payloadHeader = document.createElement('div');
    payloadHeader.className = 'payload-header';
    payloadHeader.innerHTML = 'üîß Raw Payload <span class="toggle-btn">[expand]</span>';
    payloadHeader.onclick = () => {
        payloadSection.classList.toggle('collapsed');
        payloadHeader.querySelector('.toggle-btn').textContent = 
            payloadSection.classList.contains('collapsed') ? '[expand]' : '[collapse]';
    };
    payloadSection.appendChild(payloadHeader);
    
    const payloadContent = document.createElement('pre');
    payloadContent.className = 'payload-content';
    payloadContent.textContent = JSON.stringify(data.payload, null, 2);
    payloadSection.appendChild(payloadContent);
    box.appendChild(payloadSection);
    
    contentArea.appendChild(box);
    scrollToBottom();
}

function displayLLMResponse(data) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = data.success ? 'action-box llm-response-box' : 'action-box llm-error-box';
    
    if (data.success) {
        box.innerHTML = `
            <div class="action-header">‚úÖ LLM Response</div>
            <div class="action-details">
                <div class="detail-item"><span class="label">Generation Time:</span> ${data.generation_time.toFixed(2)}s</div>
                <div class="detail-item"><span class="label">Response Length:</span> ${data.response_length} characters</div>
            </div>
        `;
        
        // Add collapsible full response
        const responseSection = document.createElement('div');
        responseSection.className = 'response-section';
        const responseHeader = document.createElement('div');
        responseHeader.className = 'response-header collapsible-header';
        responseHeader.innerHTML = 'üí¨ Full Response <span class="toggle-btn">[collapse]</span>';
        responseHeader.onclick = () => {
            responseSection.classList.toggle('collapsed');
            responseHeader.querySelector('.toggle-btn').textContent = 
                responseSection.classList.contains('collapsed') ? '[expand]' : '[collapse]';
        };
        responseSection.appendChild(responseHeader);
        
        const responseContent = document.createElement('div');
        responseContent.className = 'response-text-full';
        responseContent.textContent = data.text; // Full response, no truncation
        responseSection.appendChild(responseContent);
        box.appendChild(responseSection);
    } else {
        box.innerHTML = `
            <div class="action-header">‚ùå LLM Error</div>
            <div class="error-message">${escapeHtml(data.error)}</div>
        `;
    }
    
    contentArea.appendChild(box);
    scrollToBottom();
}

function displayEvaluationStart(data) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = 'action-box evaluation-box';
    box.innerHTML = `
        <div class="action-header">üéØ Starting Evaluation</div>
        <div class="action-details">
            <div class="detail-item">${data.message || 'Evaluating response quality...'}</div>
        </div>
    `;
    contentArea.appendChild(box);
    scrollToBottom();
}

function displayEvaluationComplete(data) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = 'action-box evaluation-result-box';
    box.innerHTML = `
        <div class="action-header">‚úÖ Evaluation Complete</div>
        <div class="action-details">
            <div class="detail-item"><span class="label">Score:</span> ${data.score.toFixed(2)}</div>
            <div class="detail-item"><span class="label">Time:</span> ${data.time.toFixed(2)}s</div>
        </div>
    `;
    contentArea.appendChild(box);
    scrollToBottom();
}

function displayTemperatureTest(data) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = 'action-box temperature-test-box';
    box.innerHTML = `
        <div class="action-header">üå°Ô∏è Temperature Test</div>
        <div class="action-details">
            <div class="detail-item"><span class="label">Iteration:</span> ${data.iteration}/${data.total}</div>
            <div class="detail-item"><span class="label">Temperature:</span> ${data.temperature.toFixed(3)}</div>
            <div class="detail-item"><span class="label">Score:</span> ${data.score.toFixed(2)}</div>
            <div class="detail-item"><span class="label">Best So Far:</span> ${data.best_score.toFixed(2)}</div>
        </div>
    `;
    contentArea.appendChild(box);
    scrollToBottom();
}

function displayImprovementIteration(data) {
    const contentArea = document.getElementById('contentArea');
    const box = document.createElement('div');
    box.className = 'action-box improvement-box';
    box.innerHTML = `
        <div class="action-header">üîÑ Improvement Iteration</div>
        <div class="action-details">
            <div class="detail-item"><span class="label">Iteration:</span> ${data.iteration}/${data.total}</div>
            <div class="detail-item"><span class="label">Current Score:</span> ${data.current_score.toFixed(2)}</div>
            <div class="detail-item"><span class="label">Previous Score:</span> ${data.previous_score.toFixed(2)}</div>
            <div class="detail-item"><span class="label">Improvement:</span> ${(data.current_score - data.previous_score).toFixed(2)}</div>
        </div>
    `;
    contentArea.appendChild(box);
    scrollToBottom();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Keep old display functions for backward compatibility (delete these later)

function displayLLMRequestHeader(data) {
    const contentArea = document.getElementById('contentArea');
    const header = document.createElement('div');
    header.className = 'llm-request-header';
    header.innerHTML = `
        <div class="header-banner">üöÄ LLM API Request</div>
    `;
    contentArea.appendChild(header);
    scrollToBottom();
}

function displayLLMEndpoint(data) {
    const contentArea = document.getElementById('contentArea');
    const endpointBox = document.createElement('div');
    endpointBox.className = 'llm-endpoint-box';
    
    // Extract endpoint URL from content
    const lines = data.content.split('\n').filter(line => line.trim());
    const endpointLine = lines.find(line => line.includes('Endpoint:') || line.includes('http'));
    
    endpointBox.innerHTML = `
        <div class="endpoint-label">üåê Endpoint:</div>
        <div class="endpoint-url">${endpointLine || data.content}</div>
    `;
    contentArea.appendChild(endpointBox);
    scrollToBottom();
}

function displayLLMParameters(data) {
    const contentArea = document.getElementById('contentArea');
    const paramsBox = document.createElement('div');
    paramsBox.className = 'llm-parameters-box';
    
    const title = document.createElement('div');
    title.className = 'params-title';
    title.textContent = 'üì¶ Request Parameters';
    paramsBox.appendChild(title);
    
    // Parse table content into structured data
    const lines = data.content.split('\n').filter(line => line.trim() && !line.includes('‚îÄ') && !line.includes('‚ïê'));
    
    const paramsGrid = document.createElement('div');
    paramsGrid.className = 'params-grid';
    
    lines.forEach(line => {
        // Skip header and decorative lines
        if (line.includes('Parameter') || line.includes('Value') || line.includes('Description')) {
            return;
        }
        
        // Extract parameter info (basic parsing)
        const parts = line.split(/\s{2,}/); // Split on 2+ spaces
        if (parts.length >= 2) {
            const paramName = parts[0].trim();
            const paramValue = parts[1].trim();
            
            if (paramName && paramValue) {
                const paramItem = document.createElement('div');
                paramItem.className = 'param-item';
                paramItem.innerHTML = `
                    <span class="param-name">${paramName}:</span>
                    <span class="param-value">${paramValue}</span>
                `;
                paramsGrid.appendChild(paramItem);
            }
        }
    });
    
    paramsBox.appendChild(paramsGrid);
    contentArea.appendChild(paramsBox);
    scrollToBottom();
}

function displayLLMPrompt(data) {
    const contentArea = document.getElementById('contentArea');
    const promptBox = document.createElement('div');
    promptBox.className = 'llm-prompt-box';
    
    const title = document.createElement('div');
    title.className = 'prompt-title';
    title.textContent = 'üìù Prompt Content';
    promptBox.appendChild(title);
    
    const promptContent = document.createElement('div');
    promptContent.className = 'prompt-content';
    
    // Clean up the content - remove box drawing characters
    let cleanContent = data.content
        .replace(/[‚îå‚îê‚îî‚îò‚îú‚î§‚îÄ‚îÇ‚î¨‚î¥‚îº‚ï≠‚ïÆ‚ï∞‚ïØ‚ïî‚ïó‚ïö‚ïù‚ïë‚ïê‚ï†‚ï£‚ï¶‚ï©‚ï¨]/g, '')
        .replace(/^\s*Prompt Content\s*$/gm, '')
        .replace(/^\s*Message Content\s*$/gm, '')
        .trim();
    
    promptContent.textContent = cleanContent;
    promptBox.appendChild(promptContent);
    
    contentArea.appendChild(promptBox);
    scrollToBottom();
}

function displayLLMPayload(data) {
    const contentArea = document.getElementById('contentArea');
    const payloadBox = document.createElement('div');
    payloadBox.className = 'llm-payload-box';
    
    const title = document.createElement('div');
    title.className = 'payload-title';
    title.textContent = 'üîß Raw JSON Payload';
    
    const toggle = document.createElement('span');
    toggle.className = 'payload-toggle';
    toggle.textContent = '[collapse]';
    toggle.onclick = () => {
        const content = payloadBox.querySelector('.payload-content');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.textContent = '[collapse]';
        } else {
            content.style.display = 'none';
            toggle.textContent = '[expand]';
        }
    };
    title.appendChild(toggle);
    payloadBox.appendChild(title);
    
    const payloadContent = document.createElement('pre');
    payloadContent.className = 'payload-content';
    
    // Clean up the content
    let cleanContent = data.content
        .replace(/[‚îå‚îê‚îî‚îò‚îú‚î§‚îÄ‚îÇ‚î¨‚î¥‚îº‚ï≠‚ïÆ‚ï∞‚ïØ‚ïî‚ïó‚ïö‚ïù‚ïë‚ïê‚ï†‚ï£‚ï¶‚ï©‚ï¨]/g, '')
        .replace(/^\s*Raw JSON Payload\s*$/gm, '')
        .replace(/^\d+\s+/gm, '') // Remove line numbers
        .trim();
    
    payloadContent.textContent = cleanContent;
    payloadBox.appendChild(payloadContent);
    
    contentArea.appendChild(payloadBox);
    scrollToBottom();
}

function displayPanel(data) {
    const contentArea = document.getElementById('contentArea');
    const panel = document.createElement('div');
    panel.className = `generic-panel panel-${data.style}`;
    
    if (data.title) {
        const title = document.createElement('div');
        title.className = 'panel-title';
        title.textContent = data.title;
        panel.appendChild(title);
    }
    
    const content = document.createElement('div');
    content.className = 'panel-content';
    content.textContent = data.content;
    panel.appendChild(content);
    
    contentArea.appendChild(panel);
    scrollToBottom();
}

function displayTable(data) {
    const contentArea = document.getElementById('contentArea');
    const tableBox = document.createElement('div');
    tableBox.className = 'generic-table';
    
    if (data.title) {
        const title = document.createElement('div');
        title.className = 'table-title';
        title.textContent = data.title;
        tableBox.appendChild(title);
    }
    
    const content = document.createElement('pre');
    content.className = 'table-content';
    content.textContent = data.content;
    tableBox.appendChild(content);
    
    contentArea.appendChild(tableBox);
    scrollToBottom();
}
